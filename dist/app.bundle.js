(()=>{var $t=Object.defineProperty;var Z=Object.getOwnPropertySymbols;var Lt=Object.prototype.hasOwnProperty,Tt=Object.prototype.propertyIsEnumerable;var tt=(t,e,n)=>e in t?$t(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,A=(t,e)=>{for(var n in e||(e={}))Lt.call(e,n)&&tt(t,n,e[n]);if(Z)for(var n of Z(e))Tt.call(e,n)&&tt(t,n,e[n]);return t};var et="memory-manager-v2",nt={mode:"timed",timerMs:7e3,strategy:"manual"},r={settings:A({},nt),best:0,devDayClaimed:!1};function Ht(t){let e=new Date(t.getFullYear(),0,0);return Math.floor((t-e)/864e5)}var W=Ht(new Date)===256;function ot(){try{let t=localStorage.getItem(et);if(t){let e=JSON.parse(t);r.best=e.best||0,r.devDayClaimed=!!e.devDayClaimed}}catch(t){}}function U(){localStorage.setItem(et,JSON.stringify({best:r.best,devDayClaimed:r.devDayClaimed}))}function st(t){r.settings=A(A({},nt),t)}function S(t){return document.getElementById(t)}function rt(t){let e=S("menu"),n=S("gameRoot"),o=S("timerRow"),i=S("startBtn"),l=S("timerSec"),d=S("menuStrategy");function y(){let g=e.querySelectorAll('input[name="mode"]');for(let u=0;u<g.length;u++)if(g[u].checked)return g[u].value;return"timed"}let w=y();o.style.display=w==="timed"?"":"none",e.addEventListener("change",function(g){if(g&&g.target&&g.target.name==="mode"){let u=g.target.value;o.style.display=u==="timed"?"":"none"}}),i.addEventListener("click",function(){let g=y(),u=parseInt(l.value,10);isNaN(u)&&(u=7),u<3&&(u=3),u>20&&(u=20);let G=u*1e3,zt=d.value;st({mode:g,timerMs:G,strategy:zt}),e.hidden=!0,e.style.display="none",n.hidden=!1;let It={mode:r.settings.mode,timerMs:r.settings.timerMs,strategy:r.settings.strategy};t(It)})}var $=t=>t*100/256,N=(t,e)=>Math.floor(Math.random()*(e-t+1))+t;function L(t){let e="";for(t++;t>0;){let n=(t-1)%26;e=String.fromCharCode(65+n)+e,t=Math.floor((t-1)/26)}return e}var at=t=>`linear-gradient(135deg, hsl(${t*47%360} 80% 50% / .92), hsl(${(t*47+25)%360} 85% 45% / .92))`;var c={blocks:[],aliveIds:[],lastId:0};function it(){c.blocks=[],c.aliveIds=[],c.lastId=0}function T(){let t=[],e=[...c.blocks].sort((o,i)=>o.start-i.start),n=0;for(let o of e)o.start>n&&t.push({start:n,size:o.start-n}),n=o.start+o.size;return n<256&&t.push({start:n,size:256-n}),t}var Y=()=>256-c.blocks.reduce((t,e)=>t+e.size,0),Bt=()=>{let t=T();return t.length?Math.max(...t.map(e=>e.size)):0},H=()=>{let t=Y();return t===0?0:1-Bt()/t};function V(t,e,n,o){if(t.size<e)return!1;let i={id:n,start:t.start,size:e,color:o};return c.blocks.push(i),c.blocks.sort((l,d)=>l.start-d.start),c.aliveIds.push(n),!0}function lt(t){let e=c.blocks.findIndex(n=>n.id===t);if(e>=0){let n=c.blocks[e];c.blocks.splice(e,1);let o=c.aliveIds.indexOf(t);return o>=0&&c.aliveIds.splice(o,1),n.size}return 0}function ct(){let t=[...c.blocks].sort((o,i)=>o.start-i.start),e=0,n=!1;for(let o of t)o.start!==e&&(o.start=e,n=!0),e+=o.size;return c.blocks=t,n}function dt(t,e){let n=T();return e==="first"?n.find(o=>o.size>=t)||null:e==="best"?n.filter(o=>o.size>=t).sort((o,i)=>o.size-i.size)[0]||null:e==="worst"&&n.filter(o=>o.size>=t).sort((o,i)=>i.size-o.size)[0]||null}var m=t=>document.getElementById(t),s={root:m("gameRoot"),mem:m("mem"),tbar:m("tbar"),timerWrap:m("timerWrap"),score:m("score"),best:m("best"),frag:m("frag"),free:m("free"),reqLabel:m("reqLabel"),q1:m("q1"),q2:m("q2"),q3:m("q3"),status:m("status"),hint:m("hint"),hearts:m("hearts"),badges:m("badges"),devday:m("devday"),btn:{defrag:m("defrag"),pause:m("pause"),restart:m("restart"),next:m("nextReq")},controls:{strategy:m("strategy"),speed:m("speed"),speedVal:m("speedVal")}};function mt(){s.root.hidden=!1}function J(t){if(s.hearts.innerHTML="",!(t<=0))for(let e=0;e<t;e++){let n=document.createElement("span");n.className="heart",s.hearts.appendChild(n)}}function k(t,e){s.score.textContent=String(t),s.best.textContent=String(e);let n=H();s.frag.textContent=Math.round(n*100)+"%",s.free.textContent=String(Y())}function Q(t,e){let n=o=>o?o.kind==="malloc"?`malloc(${o.size})`:`free(${o.name})`:"\u2014";s.reqLabel.textContent=n(t),s.q1.textContent=n(e[0]),s.q2.textContent=n(e[1]),s.q3.textContent=n(e[2])}function z(t){s.status.textContent=t}function _(t){s.status.innerHTML=t}function B(t){s.hint.textContent=t||""}function b(t,e,n,o){let i=s.mem;i.innerHTML="";for(let l=1;l<16;l++){let d=document.createElement("div");d.className="tick",d.style.left=l*100/16+"%",i.appendChild(d)}if(e&&e.kind==="malloc"&&n==="manual")for(let l of T()){let d=document.createElement("div");d.className="hole",d.style.left=$(l.start)+"%",d.style.width=$(l.size)+"%",d.textContent=l.size,l.size<e.size?d.classList.add("bad"):d.addEventListener("click",()=>o(l)),i.appendChild(d)}for(let l of t){let d=document.createElement("div");d.className="block",d.style.left=$(l.start)+"%",d.style.width=$(l.size)+"%",d.innerHTML=`<span class="label">${L(l.id)}\xB7${l.size}</span>`,i.appendChild(d)}}function ut(t){let e=s.tbar;e.style.transition="none",e.style.transform="scaleX(1)",requestAnimationFrame(()=>{e.style.transition=`transform ${t}ms linear`,e.style.transform="scaleX(0)"})}function R(){let t=s.tbar;t.style.transition="none",t.style.transform="scaleX(0)"}function ft(t){s.timerWrap.style.display=t?"":"none"}function I(t,e=!1){let n=document.createElement("span");n.className="badge"+(e?" green":""),n.textContent=t,s.badges.prepend(n),setTimeout(()=>n.remove(),8e3)}function pt(){let t=["0","1"],n=window.innerWidth,o=window.innerHeight;for(let i=0;i<80;i++){let l=document.createElement("span");l.className="confetti",l.textContent=t[Math.random()*t.length|0];let d=Math.random()*n,y=Math.random()*360|0,w=12+Math.random()*14;l.style.left=d+"px",l.style.fontSize=w+"px",l.style.transform=`translateY(-10px) rotate(${y}deg)`,document.body.appendChild(l);let g=900+Math.random()*1100,u=(Math.random()*2-1)*140,G=o+40;l.animate([{transform:`translate(0px,-10px) rotate(${y}deg)`,opacity:1},{transform:`translate(${u}px, ${G}px) rotate(${y+180}deg)`,opacity:.8}],{duration:g,easing:"cubic-bezier(.2,.8,.2,1)"}).onfinish=()=>l.remove()}}var O=null,h=null,P=0,D=[],v=null;function gt(t){let e=Math.max(1,window.devicePixelRatio||1),{clientWidth:n,clientHeight:o}=t;t.width=n*e,t.height=o*e;let i=16*e;h.font=`${i}px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace`,P=Math.floor(t.width/(i*.75)),D=Array(P).fill(0).map(()=>Math.floor(Math.random()*-50))}function ht(){if(!h||!v)return;h.fillStyle="rgba(0, 0, 0, 0.15)",h.fillRect(0,0,v.width,v.height);let t=Math.random()<.5?"0":"1";h.fillStyle="#86efac";let e=parseInt(h.font,10);for(let n=0;n<P;n++){let o=n*(e*.75),i=D[n]*e;h.fillText(t,o,i),i>v.height&&Math.random()>.975&&(D[n]=0),D[n]++}O=window.requestAnimationFrame(ht)}function Rt(t){v=t,h=t.getContext("2d"),gt(t),window.addEventListener("resize",yt,{passive:!0}),h.fillStyle="rgba(0,0,0,0.6)",h.fillRect(0,0,t.width,t.height),ht()}function Dt(){O&&(cancelAnimationFrame(O),O=null),window.removeEventListener("resize",yt),h=null,P=0,D=[],v=null}function yt(){v&&gt(v)}function xt(t,e,n){let o=document.getElementById("gameOver"),i=document.getElementById("matrixCanvas"),l=document.getElementById("goScore"),d=document.getElementById("goBest"),y=document.getElementById("goOk");l.textContent=String(t),d.textContent=String(e),o.hidden=!1,Rt(i);let w=()=>{y.removeEventListener("click",w),Dt(),o.hidden=!0,typeof n=="function"&&n()};y.addEventListener("click",w)}var F=3,p=0,a=null,M=[],f=null,j=0,x=0,q=5;function Ft(){let t=Math.random();return t<.55?N(4,16):t<.85?N(17,32):N(33,48)}function qt(){return c.lastId++}function vt(){let t=Math.random();if(c.aliveIds.length===0||t<.65){let o=qt(),i=Ft();return{kind:"malloc",id:o,name:L(o),size:i,color:at(o)}}let e=c.aliveIds,n=e[Math.random()*e.length|0];return{kind:"free",id:n,name:L(n)}}function bt(){for(;M.length<3;)M.push(vt())}function At(){M.length===0&&bt();let t=M.shift();return bt(),t}function K(t,e=!1){x=0,p+=t.size+Math.max(0,20-Math.round(H()*100)/5),I(`${e?"AUTO ":""}ALLOC ${t.name}[${t.size}]`),k(p,r.best)}function Mt(t){let e=dt(t.size,s.controls.strategy.value);return e?V(e,t.size,t.id,t.color):!1}function kt(){a&&a.kind==="malloc"&&(Mt(a)?(K(a,!0),E()):(Nt("OOM: \u043D\u0435\u0442 \u043F\u043E\u0434\u0445\u043E\u0434\u044F\u0449\u0435\u0433\u043E \u043E\u043A\u043D\u0430. \u0418\u0441\u043F\u043E\u043B\u044C\u0437\u0443\u0439\u0442\u0435 Defrag!"),E()))}function Ct(){let t=r.settings.timerMs/parseFloat(s.controls.speed.value);j=performance.now(),clearTimeout(f),f=setTimeout(kt,t),ut(t)}function Et(t){let n=s.controls.strategy.value==="manual"?"\u043A\u043B\u0438\u043A\u043D\u0438\u0442\u0435 \u043F\u043E \u0441\u0432\u043E\u0431\u043E\u0434\u043D\u043E\u043C\u0443 \u043E\u043A\u043D\u0443":s.controls.strategy.options[s.controls.strategy.selectedIndex].text;return`<span class="rq">\u0417\u0430\u043F\u0440\u043E\u0441</span> ${t.kind==="malloc"?`<code class="op malloc">malloc(${t.size})</code>`:`<code class="op free">free(${t.name})</code>`} <span class="arrow">\u2192</span> <span class="action">${n}</span>`}function E(){if(clearTimeout(f),f=null,r.settings.mode==="timed"&&R(),a=At(),Q(a,M),!!a){if(a.kind==="free"){let t=lt(a.id);t>0?I(`FREE ${a.name}[${t}]`):I(`FREE ${a.name} (\u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D)`),b(c.blocks,a,s.controls.strategy.value,C),k(p,r.best),setTimeout(()=>E(),300/parseFloat(s.controls.speed.value));return}_(Et(a)),b(c.blocks,a,s.controls.strategy.value,C),r.settings.mode==="timed"?Ct():s.controls.strategy.value!=="manual"?Mt(a)?(K(a,!0),b(c.blocks,a,s.controls.strategy.value,C),k(p,r.best),setTimeout(()=>E(),200)):B(`\u041D\u0435\u0442 \u043F\u043E\u0434\u0445\u043E\u0434\u044F\u0449\u0435\u0433\u043E \u043E\u043A\u043D\u0430. \u041F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 Defrag \u0438\u043B\u0438 \u0434\u043E\u0436\u0434\u0438\u0442\u0435\u0441\u044C free. \u041F\u0440\u043E\u043F\u0443\u0441\u043A\u0438: ${x}/${q}. \u041A\u043D\u043E\u043F\u043A\u0430 \xAB\u0414\u0430\u043B\u0435\u0435\xBB \u0437\u0430\u0441\u0447\u0438\u0442\u0430\u0435\u0442 \u043F\u0440\u043E\u043F\u0443\u0441\u043A.`):B(`\u041A\u043B\u0438\u043A \u043F\u043E \u043F\u043E\u0434\u0445\u043E\u0434\u044F\u0449\u0435\u043C\u0443 \u043E\u043A\u043D\u0443 \u2014 \u0440\u0430\u0437\u043C\u0435\u0441\u0442\u0438\u0442\u044C. \xAB\u0414\u0430\u043B\u0435\u0435\xBB \u0437\u0430\u0441\u0447\u0438\u0442\u0430\u0435\u0442 \u043F\u0440\u043E\u043F\u0443\u0441\u043A (${x}/${q}).`)}}function C(t){!a||a.kind!=="malloc"||t.size<a.size||V(t,a.size,a.id,a.color)&&(K(a,!1),b(c.blocks,a,s.controls.strategy.value,C),k(p,r.best),E())}function Nt(t){if(r.settings.mode!=="timed"){B(t);return}F--,z(`\u26D4 ${t}`),J(F),F<=0&&wt()}function wt(){clearTimeout(f),f=null,R(),p>r.best&&(r.best=p,U()),s.best.textContent=String(r.best),xt(p,r.best,()=>{document.getElementById("menu").hidden=!1,document.getElementById("menu").style.display="",document.getElementById("gameRoot").hidden=!0})}function Ot(){let t=ct();b(c.blocks,a,s.controls.strategy.value,C),H()===0&&t?(I("FULL DEFRAG +256",!0),p+=128,x=0,W&&!r.devDayClaimed&&(p+=256,r.devDayClaimed=!0,s.devday.style.display="none"),pt(),k(p,r.best),U()):t&&(I("Compaction"),x=0)}function Pt(){s.btn.defrag.addEventListener("click",()=>Ot()),s.btn.pause.addEventListener("click",()=>{if(r.settings.mode!=="timed")return;!!f?(clearTimeout(f),f=null,R(),s.btn.pause.textContent="\u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C"):(Ct(),s.btn.pause.textContent="\u041F\u0430\u0443\u0437\u0430")}),s.btn.restart.addEventListener("click",()=>{clearTimeout(f),f=null,R(),document.getElementById("menu").hidden=!1,document.getElementById("gameRoot").hidden=!0}),s.btn.next.addEventListener("click",()=>{if(r.settings.mode!=="timed"&&a&&a.kind==="malloc"&&(x++,z(`\u041F\u0440\u043E\u043F\u0443\u0441\u043A malloc: ${x}/${q}`),x>=q)){z("\u26D4 \u0421\u043B\u0438\u0448\u043A\u043E\u043C \u043C\u043D\u043E\u0433\u043E \u043F\u0440\u043E\u043F\u0443\u0441\u043A\u043E\u0432 \u043D\u0435\u0432\u044B\u043F\u043E\u043B\u043D\u0435\u043D\u043D\u044B\u0445 \u0437\u0430\u043F\u0440\u043E\u0441\u043E\u0432."),wt();return}E()}),s.controls.strategy.addEventListener("change",()=>{a&&a.kind==="malloc"?_(Et(a)):z(s.controls.strategy.value==="manual"?"\u0420\u0435\u0436\u0438\u043C \u0440\u0443\u0447\u043D\u043E\u0433\u043E \u0440\u0430\u0437\u043C\u0435\u0449\u0435\u043D\u0438\u044F \u2014 \u043A\u043B\u0438\u043A \u043F\u043E \u0441\u0432\u043E\u0431\u043E\u0434\u043D\u043E\u043C\u0443 \u043E\u043A\u043D\u0443.":"\u0410\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0430\u044F \u0441\u0442\u0440\u0430\u0442\u0435\u0433\u0438\u044F: \u0440\u0430\u0437\u043C\u0435\u0449\u0435\u043D\u0438\u0435 \u0431\u0443\u0434\u0435\u0442 \u0432\u044B\u043F\u043E\u043B\u043D\u0435\u043D\u043E \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438."),b(c.blocks,a,s.controls.strategy.value,C)}),s.controls.speed.addEventListener("input",()=>{if(s.controls.speedVal.textContent=s.controls.speed.value+"\xD7",f){let t=performance.now()-j,e=Math.max(0,r.settings.timerMs-t);clearTimeout(f);let n=e/parseFloat(s.controls.speed.value),o=s.tbar;o.style.transition="none";let i=e/r.settings.timerMs;o.style.transform="scaleX("+i+")",requestAnimationFrame(()=>{o.style.transition=`transform ${n}ms linear`,o.style.transform="scaleX(0)"}),f=setTimeout(kt,n)}})}function Gt(){s.best.textContent=String(r.best),ft(r.settings.mode==="timed"),s.btn.pause.style.display=r.settings.mode==="timed"?"":"none",J(r.settings.mode==="timed"?F:0),W&&!r.devDayClaimed?s.devday.style.display="inline-flex":s.devday.style.display="none"}function St(t){r.settings=t,F=3,p=0,a=null,M=[],clearTimeout(f),f=null,j=0,x=0,it(),mt(),Pt(),Gt();for(let e=0;e<3;e++)M.push(vt());b(c.blocks,a,s.controls.strategy.value,C),k(p,r.best),Q(a,M),z("\u0413\u043E\u0442\u043E\u0432\u043E. \u041E\u0431\u0440\u0430\u0431\u0430\u0442\u044B\u0432\u0430\u0439\u0442\u0435 \u0437\u0430\u043F\u0440\u043E\u0441\u044B \u0438 \u0441\u043B\u0435\u0434\u0438\u0442\u0435 \u0437\u0430 \u0444\u0440\u0430\u0433\u043C\u0435\u043D\u0442\u0430\u0446\u0438\u0435\u0439."),B(`\u0412 \xAB\u0411\u0435\u0437 \u0442\u0430\u0439\u043C\u0435\u0440\u0430\xBB \xAB\u0414\u0430\u043B\u0435\u0435\xBB \u0437\u0430\u0441\u0447\u0438\u0442\u044B\u0432\u0430\u0435\u0442 \u043F\u0440\u043E\u043F\u0443\u0441\u043A. \u041B\u0438\u043C\u0438\u0442: ${q}.`),E()}window.addEventListener("DOMContentLoaded",()=>{ot(),rt(t=>{St(t)})});})();
